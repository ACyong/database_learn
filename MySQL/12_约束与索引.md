# 约束与索引
> 约束是对表中数据进行进一步限制，保证表中数据的完整性、一致性和正确性。索引是为了加快搜索速度。

## 1. 约束

1. 主键约束
> 主键能够唯一地标识表中的一行，比如学生表中的学生id。它的主要作用就是能够将表中的每一行数据区分开来，这样可以避免在执行update或delete操作时发生错误。

满足以下条件的任意列都可以作为主键：
```
任意两行的主键值不相同
每一行都存在主键值（即主键值不能为NULL）
包含主键值的列从不进行修改与更新
```

设置主键有下面几种方式：在表定义时直接指定主键, 或使用ALTER TABLE语句来设置主键约束
```
--第一种方式
create table student(
    stu_id char(9) primary key,
    name char(10));

--第二种方式
create table student(
    stu_id char(9),
    name char(10),
    primary key(stu_id)
);

--第三种方式
alter table student add constraint primary key(stu_id);
```
注意: 
```
如果要更新主键，需要先将表中原来的主键drop掉，在重新添加主键约束。
```

2. 外键约束
> 外键是表中的一列，它的值必须在另一个表的主键中，外键是保证引用完整性的极其重要部分。

举个栗子：
```
订单表 orders（订单号，订单日期，顾客id）
顾客表 customers（顾客id，顾客name，顾客地址）

订单表中，订单号是唯一的，但是顾客id不一定是唯一的，因为同一个顾客可能会产生多个订单。而在顾客表中，顾客id是唯一的。
订单表中顾客id的合法值应该为顾客表中顾客id的某个值，所以我们定义订单表中的顾客id为外键，它的值要以顾客表的主键（顾客id）为参考。
```

创建外键约束的方法：
```
--第一种方式
create table orders(
    order_num int not null primary key,
    order_date datetime not null,
    cust_id char(10) not null references Customers(cust_id)
);

--第二种方法
alter table orders add constraint foreign key(cust_id) references customers(cust_id);
最后再说一下什么叫引用完整性。
```

注意:
```
引用完整性就是定义外关键字与主关键字之间的引用规则。如果要删除被引用的对象，那么也要删除引用它的所有对象，或者把引用值设置为空(如果允许的话)。订单表中的顾客id为外键，它引用的是顾客表的主键。所以订单表为引用对象，顾客表为被引用对象。设想如果我们要从顾客表中删除某个顾客，而该顾客在订单表中有引用记录，一旦将该顾客删除，那么对应的订单表将失去引用对象，这对系统来说确实是不安全的。
```

3. 唯一约束
> 唯一性约束用来保证某列中的数值是唯一的。

它和主键的区别有下面几点：
```
主键必须非空，而唯一约束可包含NULL
每一个表只能有一个主键，却可以有多个唯一约束
唯一约束可修改或更新
唯一约束不能用来定义外键
```

创建方式：
```
直接在表定义时使用unique关键字
使用单独的constraint定义
```

4. check约束
> check约束用来保证某一列的数值满足某种特定的条件

它的用途主要有以下几种：
```
1. 检查最大最小值，比如订单数量不能为0
2. 指定范围：比如发货日期必须大于等于今天的日期并且不超过明年的这个时候
3. 只允许特定的值，比如性别列中只允许填写"M" or "F"
```

创建check约束：
```
---第一种方法
create table OrderItem(
    order_num int not null,
    order_item int not null,
    quantity int not null check (quantity > 0)
);

---第二种方法
add constraint check (gender in ['M','F']);
```

注意:
```
mysql中check约束貌似没用？？？使用enum()和触发器来解决~~~
```

5. 非空和默认值
> 这也是常用的约束手段，分别使用not null和default来进行约束即可。

默认约束(default)
```
1、作用 ：在插入记录时，如果不为该字段赋值，则使用默认值
2、格式 ：字段名 数据类型 default 值
```

非空约束(not null)
```
1、作用 ：不允许将该字段的值有NULL记录
2、格式 ：字段名 数据类型 not null
```
---


## 2、索引
> 创建索引是为了加快搜索速度。数据库中表的数据量较大的情况下，对于查询响应时间不能满足业务需求，可以合理的使用索引提升查询效率。

1. 索引的分类

从功能逻辑上说，索引主要有 4 种，分别是普通索引、唯一索引、主键索引和全文索引。
```
1. 普通索引是基础的索引，没有任何约束，主要用于提高查询效率。

2. 唯一索引就是在普通索引的基础上增加了数据唯一性的约束，在一张数据表里可以有多个唯一索引。

3. 主键索引在唯一索引的基础上增加了不为空的约束，也就是 NOT NULL+UNIQUE，一张表里最多只有一个主键索引。

4. 全文索引用的不多，MySQL 自带的全文索引只支持英文。通常可以采用专门的全文搜索引擎，比如 ES(ElasticSearch) 和 Solr。
```

按照物理实现方式，索引可以分为 2 种：聚集索引和非聚集索引。非聚集索引也称为二级索引或者辅助索引。
```
1. 聚集索引可以按照主键来排序存储数据，这样在查找行的时候非常有效。举个例子，如果是一本汉语字典，想要查找“数”这个字，直接在书中找汉语拼音的位置即可，也就是拼音“shu”。这样找到了索引的位置，在它后面就是想要找的数据行。

2. 非聚集索引在数据库系统会有单独的存储空间存放非聚集索引，这些索引项是按照顺序存储的，但索引项指向的内容是随机存储的。也就是说系统会进行两次查找，第一次先找到索引，第二次找到索引对应的位置取出数据行。非聚集索引不会把索引指向的内容像聚集索引一样直接放到索引的后面，而是维护单独的索引表（只维护索引，不维护索引指向的数据），为数据检索提供方便。我们还以汉语字典为例，如果想要查找“数”字，那么按照部首查找的方式，先找到“数”字的偏旁部首，然后这个目录会告诉我们“数”字存放到第多少页，再去指定的页码找这个字。
```

聚集索引与非聚集索引的原理不同，在使用上也有一些区别：
```
1. 聚集索引的叶子节点存储的就是数据记录，非聚集索引的叶子节点存储的是数据位置。
2. 非聚集索引不会影响数据表的物理存储顺序。一个表只能有一个聚集索引，因为只能有一种排序存储的方式，但可以有多个非聚集索引，也就是多个索引目录提供数据检索。
3. 使用聚集索引的时候，数据的查询效率高，但如果对数据进行插入，删除，更新等操作，效率会比非聚集索引低。
```

注意: 
```
聚集索引指表中数据行按索引的排序方式进行存储，对查找行很有效。只有当表包含聚集索引时，表内的数据行才会按找索引列的值在磁盘上进行物理排序和存储。每一个表只能有一个聚集索引，因为数据行本身只能按一个顺序存储。

InnoDB按照主键进行聚集，如果没有定义主键，InnoDB会试着使用唯一的非空索引来代替。如果没有这种索引，InnoDB就会定义隐藏的主键然后在上面进行聚集。所以，对于聚集索引来说，创建主键的时候，自动就创建了主键的聚集索引。除聚集索引外的其他索引都是非聚集索引.

聚集索引是面向读取的设计，因为数据会按照聚集索引的大小顺序写入到磁盘，因此聚集索引会存在存储顺序的问题。而更新，插入的内容往往都是随机的，这时如果还是用聚集索引，所有的记录就需要重新进行排序并重新写入到磁盘中，所以效率相比于非聚集索引可能会降低。而非聚集索引只是存储索引，只需要更新这个索引即可，不需要对所有的记录重新排序。所以一般都采用自增主键来避免这种问题
```

索引可以按照字段个数进行划分，分成单一索引和联合索引。索引列为一列时为单一索引；多个列组合在一起创建的索引叫做联合索引。
```
创建联合索引时，需要注意创建时的顺序问题，因为联合索引 (x, y, z) 和 (z, y, x) 在使用的时候效率可能会存在差别。这里需要说明的是联合索引存在最左匹配原则，也就是按照最左优先的方式进行索引的匹配。比如举例的 (x, y, z)，如果查询条件是 WHERE x=1 AND y=2 AND z=3，就可以匹配上联合索引；如果查询条件是 WHERE y=2，就无法匹配上联合索引。
```

2. 建立普通索引
create index <索引名> on <表名>(列名)；

3. 建立复合索引
create index <索引名> on <表名>(列名组)；

4. 创建唯一索引
create unique index <索引名> on <表名>(列名)；

5. 创建主键索引
alter table <表名> add primary key(列名);

注意:
```
全文索引主要用来查找文本中的关键字，而不是直接与索引中的值相比较, 目前只有char、varchar，text 列上可以创建全文索引
```

6. 删除索引, 删除索引只能一个一个删除
drop index <索引名> on <表名>

7. 索引的优点
```
为用来排序或者是分组的字段添加索引可以加快分组和排序顺序
加快了搜索的速度
建立索引可以加快表与表之间的连接
```

8. 索引的缺点
```
索引的确能改善搜索的速度，但是却降低了更新、删除数据的性能，原因在于每次删除或更新数据就需要对索引进行更新
索引其实也是一张表，所以建立索引必然会占据一定的内存空间
```

注意:
```
1. 索引名必须唯一

2. 主键索引是一种特殊的唯一索引，它的值是唯一的且不能存在空值，通常在表定义时直接设置

3. 唯一约束和唯一索引在 MySQL 数据库里区别：
概念上不同，约束是为了保证数据的完整性，索引是为了辅助查询
创建唯一约束时，会自动的创建唯一索引, MySQL 中唯一约束是通过唯一索引实现的，为了保证没有重复值，在插入新记录时会再检索一遍，怎样检索快，当然是建索引了，所以，在创建唯一约束的时候就创建了唯一索引。
在理论上，不一样，在实际使用时，基本没有区别
```
